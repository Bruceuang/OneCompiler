cmake_minimum_required(VERSION 3.20.0)
project(OneCompiler VERSION 0.0.1 LANGUAGES CXX C)

# åŸºæœ¬è®¾ç½®
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# è®¾ç½®æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

# åŒ…å«å­æ¨¡å—é…ç½®
include(cmake/SubmodulesConfig.cmake)
include(cmake/SubmodulesManager.cmake)

# æ£€æŸ¥å­æ¨¡å—çŠ¶æ€
message(STATUS "ğŸ” æ£€æŸ¥LLVMå­æ¨¡å—çŠ¶æ€...") 
check_llvm_submodule(LLVM_STATUS) 
if(NOT LLVM_STATUS) 
    message(STATUS "âŒ LLVMå­æ¨¡å—æœªåˆå§‹åŒ–") 
    show_llvm_help() 
    message(FATAL_ERROR "âŒ LLVMå­æ¨¡å—æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåˆå§‹åŒ–LLVMå­æ¨¡å—") 
endif()

# æ„å»ºLLVMå­æ¨¡å—
message(STATUS "ğŸ”§ æ„å»ºLLVM/MLIR...") 
build_llvm_submodule(LLVM_OK)
if(NOT LLVM_OK)
    message(FATAL_ERROR "âŒ LLVMå­æ¨¡å—æ„å»ºå¤±è´¥")
endif()

# è®¾ç½®LLVMå’ŒMLIRè·¯å¾„
set(LLVM_DIR "${LLVM_BUILD_DIR}/lib/cmake/llvm") 
set(MLIR_DIR "${LLVM_BUILD_DIR}/lib/cmake/mlir") 
message(STATUS "âœ… LLVMè·¯å¾„: ${LLVM_DIR}") 
message(STATUS "âœ… MLIRè·¯å¾„: ${MLIR_DIR}")

# å°†è·¯å¾„æ·»åŠ åˆ°CMAKE_PREFIX_PATH
list(APPEND CMAKE_PREFIX_PATH "${LLVM_DIR}") 
list(APPEND CMAKE_PREFIX_PATH "${MLIR_DIR}")

# æ·»åŠ å­ç›®å½•
add_subdirectory(src)

# æ·»åŠ æµ‹è¯•å’Œç¤ºä¾‹
if(EXISTS ${CMAKE_SOURCE_DIR}/test/CMakeLists.txt)
    add_subdirectory(test)
endif()

if(EXISTS ${CMAKE_SOURCE_DIR}/examples/CMakeLists.txt)
    add_subdirectory(examples)
endif()